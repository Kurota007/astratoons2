{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "Editar Perfil" %}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .visually-hidden-file-input {
        border: 0;
        clip: rect(0 0 0 0);
        height: 1px;
        margin: -1px;
        overflow: hidden;
        padding: 0;
        position: absolute;
        width: 1px;
        white-space: nowrap;
    }
    
    input:disabled {
        color: #D1D5DB;
        -webkit-text-fill-color: #D1D5DB;
        opacity: 1;
    }

    #id_active_badges {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #id_active_badges li {
        margin-bottom: 0.5rem;
    }

    #id_active_badges label {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        color: #D1D5DB;
    }

    #id_active_badges input[type="checkbox"] {
        height: 1rem;
        width: 1rem;
        margin-right: 0.75rem;
        cursor: pointer;
        appearance: none;
        background-color: #374151;
        border: 1px solid #4B5563;
        border-radius: 0.25rem;
        display: grid;
        place-content: center;
    }

    #id_active_badges input[type="checkbox"]::before {
        content: "";
        width: 0.65em;
        height: 0.65em;
        transform: scale(0);
        transition: 120ms transform ease-in-out;
        box-shadow: inset 1em 1em #4F46E5;
        transform-origin: bottom left;
        clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }

    #id_active_badges input[type="checkbox"]:checked::before {
        transform: scale(1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-gray-850 shadow-xl rounded-lg p-6 md:p-8">
        <h2 class="text-2xl font-bold text-white mb-8">{% trans "Editar Perfil" %}</h2>

        <form method="post" action="{% url 'accounts:profile_edit' %}" enctype="multipart/form-data" id="avatarUploadForm">
            {% csrf_token %}
            <div class="mb-8">
                <h3 class="form-section-title text-lg font-bold mb-4 text-white">{% trans "Foto de Perfil" %}</h3>
                <div class="flex flex-col items-center">
                    <div class="relative mb-4">
                        <img id="avatarPreviewDisplay"
                             src="{% if profile.get_display_avatar_url %}{{ profile.get_display_avatar_url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}"
                             alt="{% trans 'User avatar' %}"
                             class="profile-avatar"> 
                    </div>
                    <div class="flex-grow text-center w-full max-w-md">
                        <p class="form-field-description text-gray-400 text-sm mb-3">{% trans "Formatos suportados: JPG, PNG (Max. 5MB)" %}</p>
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                            <label for="id_site_avatar_input" class="file-input-label btn btn-primary text-sm w-full sm:w-auto cursor-pointer">
                                <i class="fas fa-upload mr-2"></i> {% trans "Alterar Foto" %}
                            </label>
                            <button type="submit" name="save_avatar" class="btn btn-secondary text-sm px-4 py-2 w-full sm:w-auto">{% trans "Salvar Avatar" %}</button>
                        </div>
                        {% if avatar_form.site_avatar.errors %}
                            <div class="form-error-message text-red-400 text-xs mt-2">
                                {% for error in avatar_form.site_avatar.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                        {% for message in messages %}
                            {% if 'avatar_upload_success' in message.tags %}
                                <p class="text-green-400 text-xs mt-2">{{ message }}</p>
                            {% elif 'avatar_upload_error' in message.tags %}
                                <p class="text-red-400 text-xs mt-2">{{ message }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <input type="file" name="site_avatar" id="id_site_avatar_input" class="visually-hidden-file-input" accept="image/jpeg, image/png">
        </form>

        <hr class="border-gray-700 my-8">

        <form method="post" action="{% url 'accounts:profile_edit' %}" id="profileInfoBioForm">
            {% csrf_token %}
            <div class="mb-8">
                <h3 class="form-section-title text-lg font-bold mb-4 text-white">{% trans "Informações Pessoais" %}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="{{ user_form.username.id_for_label }}" class="form-label block text-gray-400 text-sm font-medium mb-1">{% trans "Nome de Usuário" %}</label>
                        {{ user_form.username }}
                        {% if user_form.username.errors %}<p class="form-error-message text-red-400 text-xs mt-1">{{ user_form.username.errors|striptags }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ profile_form.display_name.id_for_label }}" class="form-label block text-gray-400 text-sm font-medium mb-1">{% trans "Nome de Exibição" %}</label>
                        {{ profile_form.display_name }}
                        {% if profile_form.display_name.errors %}<p class="form-error-message text-red-400 text-xs mt-1">{{ profile_form.display_name.errors|striptags }}</p>{% endif %}
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="form-section-title text-lg font-bold mb-4 text-white">{% trans "Biografia" %}</h3>
                <div>
                    {{ profile_form.bio }}
                    {% if profile_form.bio.errors %}<p class="form-error-message text-red-400 text-xs mt-1">{{ profile_form.bio.errors|striptags }}</p>{% endif %}
                    <p class="form-field-description text-gray-400 text-xs mt-2">{% trans "Conte um pouco sobre você (max. 200 caracteres)" %}</p>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="form-section-title text-lg font-bold mb-4 text-white">{% trans "Badges Ativos" %}</h3>
                
                {% if profile_form.active_badges.field.queryset.exists %}
                    {{ profile_form.active_badges }}
                {% else %}
                    <p class="text-gray-400 text-sm">{% trans "Você ainda não possui nenhum badge. Visite a loja para adquirir!" %}</p>
                {% endif %}

                {% if profile_form.active_badges.errors %}
                    <div class="form-error-message text-red-400 text-xs mt-1">
                        {{ profile_form.active_badges.errors|striptags }}
                    </div>
                {% endif %}
                <p class="form-field-description text-gray-400 text-xs mt-2">{% trans "Escolha até 2 badges para exibir no seu perfil." %}</p>
            </div>

            <div class="mb-8">
                <h3 class="form-section-title text-lg font-bold mb-4 text-white">{% trans "E-mail" %}</h3>
                <div>
                    {{ user_form.email }}
                    {% if user_form.email.errors %}<p class="form-error-message text-red-400 text-xs mt-1">{{ user_form.email.errors|striptags }}</p>{% endif %}
                    <p class="form-field-description text-gray-400 text-xs mt-2">{% trans "Este é o e-mail associado à sua conta" %}</p>
                </div>
            </div>

            <div class="mt-6 text-right">
                <button type="submit" name="save_profile_info" class="btn btn-primary px-6 py-2">{% trans "Salvar Alterações" %}</button>
            </div>
        </form>

    </div>
</div>
{% endblock content %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarInputId = "id_site_avatar_input";
    const avatarUploadInput = document.getElementById(avatarInputId);
    const avatarPreviewDisplay = document.getElementById('avatarPreviewDisplay');

    if (avatarUploadInput && avatarPreviewDisplay) {
        avatarUploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const allowedTypes = ['image/jpeg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    alert("{% trans 'Formato de arquivo inválido. Apenas JPG e PNG são permitidos.' %}");
                    avatarUploadInput.value = '';
                    return;
                }
                if (file.size > 5 * 1024 * 1024) { // 5MB
                    alert("{% trans 'Arquivo muito grande. O tamanho máximo é 5MB.' %}");
                    avatarUploadInput.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    avatarPreviewDisplay.src = event.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
    }
});
</script>
{% endblock extra_js %}