{% comment %} accounts/templates/accounts/password_reset_confirm.html {% endcomment %}
{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Definir Nova Senha" %}{% endblock %}

{% block body_class %}template-password-reset-confirm theme-dark{% endblock %}

{% block extra_css %}
    <style> body { padding-top: 4rem !important; } </style> {# Espaço para navbar fixa #}
{% endblock %}

{% block content %}
<div class="main-content-area auth-page-wrapper">
    <div class="container auth-container">
        <div class="auth-card">
            <div class="auth-card-content">
                {% if validlink %} {# Verifica se o link/token é válido #}
                    <div class="auth-header">
                        <h1 class="auth-title">{% trans "Definir Nova Senha" %}</h1>
                        <p class="auth-subtitle">{% trans "Por favor, insira sua nova senha duas vezes para confirmar." %}</p>
                    </div>

                    {% if form.non_field_errors %}
                        <div class="form-errors non-field-errors mb-4">
                            {% for error in form.non_field_errors %} <p>{{ error }}</p> {% endfor %}
                        </div>
                    {% endif %}

                    <form method="post" class="auth-form">
                        {% csrf_token %}
                        <div class="form-fields-wrapper">
                            {# Campo Nova Senha 1 (new_password1) #}
                            <div class="form-field-group">
                                <label for="{{ form.new_password1.id_for_label }}" class="form-label">{% trans 'Nova senha' %}</label>
                                <div class="input-wrapper">
                                    <span class="input-icon-left"><i class="fas fa-lock"></i></span>
                                    <input type="password" name="{{ form.new_password1.name }}" required id="{{ form.new_password1.id_for_label }}"
                                           class="input-field" autocomplete="new-password" placeholder=" ">
                                    <div class="input-icon-wrapper password-toggle-wrapper">
                                        <button type="button" class="password-toggle-btn" id="togglePassword1" aria-label="{% trans 'Mostrar/Ocultar senha' %}">
                                            <i class="fas fa-eye input-icon" id="eyeIcon1"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="password-strength mt-2"> {# Indicador de força #}
                                    <div class="strength-bar" id="passwordStrength"></div>
                                </div>
                                {% if form.new_password1.help_text %}<p class="help-text">{{ form.new_password1.help_text|safe }}</p>{% endif %}
                                {% if form.new_password1.errors %}<div class="form-errors field-errors">{% for error in form.new_password1.errors %}<p>{{ error }}</p>{% endfor %}</div>{% endif %}
                            </div>

                            {# Campo Nova Senha 2 (new_password2) #}
                            <div class="form-field-group">
                                <label for="{{ form.new_password2.id_for_label }}" class="form-label">{% trans 'Confirmar nova senha' %}</label>
                                <div class="input-wrapper">
                                    <span class="input-icon-left"><i class="fas fa-lock"></i></span>
                                    <input type="password" name="{{ form.new_password2.name }}" required id="{{ form.new_password2.id_for_label }}"
                                           class="input-field" autocomplete="new-password" placeholder=" ">
                                    <div class="input-icon-wrapper password-toggle-wrapper">
                                        <button type="button" class="password-toggle-btn" id="togglePassword2" aria-label="{% trans 'Mostrar/Ocultar senha de confirmação' %}">
                                            <i class="fas fa-eye input-icon" id="eyeIcon2"></i>
                                        </button>
                                    </div>
                                </div>
                                <p id="passwordMatch" class="help-text password-match-status mt-1" style="display: none;"></p> {# Indicador de Match #}
                                {% if form.new_password2.errors %}<div class="form-errors field-errors">{% for error in form.new_password2.errors %}<p>{{ error }}</p>{% endfor %}</div>{% endif %}
                            </div>
                        </div>
                        <div class="form-submit-group">
                            <button type="submit" class="button button-primary auth-button w-full">
                                <i class="fas fa-save mr-2"></i> {% trans "Alterar Senha" %} {# Mudado o texto do botão #}
                            </button>
                        </div>
                    </form>

                {% else %} {# Mensagem se o link for inválido ou expirado #}
                    <div class="auth-header text-center">
                        <div class="error-icon mb-4"><i class="fas fa-times-circle"></i></div>
                        <h1 class="auth-title">{% trans "Link Inválido" %}</h1>
                        <p class="auth-subtitle">
                            {% blocktrans %}O link de redefinição de senha era inválido, possivelmente porque já foi usado ou expirou. Por favor, solicite uma nova redefinição de senha.{% endblocktrans %}
                        </p>
                        <div class="mt-8">
                            <a href="{% url 'accounts:password_reset' %}" class="button button-secondary">{% trans "Solicitar Novo Link" %}</a>
                        </div>
                    </div>
                {% endif %} {# Fim do if validlink #}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {# JS para toggle, força e match de senha #}
    <script>
         function setupPasswordToggle(inputId, buttonId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = document.getElementById(buttonId);
            const eyeIcon = document.getElementById(iconId);
            if (passwordInput && toggleButton && eyeIcon) {
                toggleButton.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    eyeIcon.classList.toggle('fa-eye'); eyeIcon.classList.toggle('fa-eye-slash');
                });
            }
        }
        function checkPasswordMatch() {
            const newPasswordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
            const confirmPasswordInput = document.getElementById('{{ form.new_password2.id_for_label }}');
            const matchText = document.getElementById('passwordMatch');
            if (!newPasswordInput || !confirmPasswordInput || !matchText) return;
            const newPassword = newPasswordInput.value; const confirmPassword = confirmPasswordInput.value;
            if (confirmPassword.length === 0 && newPassword.length === 0) { matchText.style.display = 'none'; return; }
            matchText.style.display = 'block';
            if (newPassword === confirmPassword && newPassword.length > 0) {
                matchText.textContent = '{% trans "As senhas coincidem!" %}'; matchText.className = 'help-text password-match-status match';
            } else if (confirmPassword.length > 0) {
                matchText.textContent = '{% trans "As senhas não coincidem!" %}'; matchText.className = 'help-text password-match-status mismatch';
            } else { matchText.style.display = 'none'; }
        }
        function updatePasswordStrength() {
            const passwordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
            const strengthBar = document.getElementById('passwordStrength');
            if (!passwordInput || !strengthBar) return;
            const password = passwordInput.value; let strength = 0; let barColor = '#333';
            if(password.length === 0) { strengthBar.style.width = '0%'; strengthBar.style.backgroundColor = barColor; return; }
            if (password.length >= 8) strength += 25;
            if (password.length >= 12) strength += 15;
            if (/[a-z]/.test(password)) strength += 10;
            if (/[A-Z]/.test(password)) strength += 15;
            if (/\d/.test(password)) strength += 15;
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 20;
            strength = Math.min(100, Math.max(0, strength));
            strengthBar.style.width = strength + '%';
            if (strength < 40) barColor = 'var(--danger-color, #ef4444)';
            else if (strength < 75) barColor = 'var(--warning-color, #f59e0b)';
            else barColor = 'var(--success-color, #22c55e)';
            strengthBar.style.backgroundColor = barColor;
        }
        document.addEventListener('DOMContentLoaded', function() {
            setupPasswordToggle('{{ form.new_password1.id_for_label }}', 'togglePassword1', 'eyeIcon1');
            setupPasswordToggle('{{ form.new_password2.id_for_label }}', 'togglePassword2', 'eyeIcon2');
            const newPassInput = document.getElementById('{{ form.new_password1.id_for_label }}');
            const confirmPassInput = document.getElementById('{{ form.new_password2.id_for_label }}');
            if(newPassInput) { newPassInput.addEventListener('input', updatePasswordStrength); newPassInput.addEventListener('input', checkPasswordMatch); }
            if(confirmPassInput) { confirmPassInput.addEventListener('input', checkPasswordMatch); }
            updatePasswordStrength(); checkPasswordMatch();
        });
    </script>
{% endblock %}