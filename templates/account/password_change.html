{% extends "base.html" %}
{% load static %}

{% block title %}Redefinir Senha - AstroToons{% endblock %}

{% block body_class %}template-password-reset-confirm theme-dark{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="main-content-area auth-page-wrapper">
    <div class="container auth-container">
        <div class="auth-card"> {# Reusa classe .recovery-card como .auth-card #}
            <div class="auth-card-content">

                {% if validlink %} {# Variável passada pela view se o link for válido #}
                    <div class="auth-header">
                        <h1 class="auth-title">Definir Nova Senha</h1>
                        <p class="auth-subtitle">Por favor, insira sua nova senha duas vezes.</p>
                    </div>

                    {# Exibe erros gerais do formulário #}
                    {% if form.non_field_errors %}
                        <div class="form-errors non-field-errors">
                            {% for error in form.non_field_errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {# O PasswordResetConfirmView passa o SetPasswordForm como 'form' #}
                    <form method="post" class="auth-form">
                        {% csrf_token %}
                        <div class="form-fields-wrapper">

                            {# Campo Nova Senha 1 #}
                            <div class="form-field-group">
                                <label for="{{ form.new_password1.id_for_label }}">Nova senha</label>
                                <div class="input-wrapper">
                                    {{ form.new_password1 }} {# Usa widget padrão ou customizado via CSS #}
                                    <div class="input-icon-wrapper password-toggle-wrapper">
                                        <button type="button" class="password-toggle-btn" id="togglePassword1">
                                            <i class="fas fa-eye input-icon" id="eyeIcon1"></i>
                                        </button>
                                    </div>
                                </div>
                                {# Indicador de força (opcional, JS abaixo) #}
                                <div class="password-strength">
                                    <div class="strength-bar" id="passwordStrength"></div>
                                </div>
                                {% if form.new_password1.errors %}<div class="form-errors field-errors">{% for error in form.new_password1.errors %}<p>{{ error }}</p>{% endfor %}</div>{% endif %}
                                {% if form.new_password1.help_text %}
                                    <p class="help-text">{{ form.new_password1.help_text|safe }}</p>
                                {% endif %}
                            </div>

                            {# Campo Nova Senha 2 #}
                            <div class="form-field-group">
                                <label for="{{ form.new_password2.id_for_label }}">Confirmar nova senha</label>
                                <div class="input-wrapper">
                                    {{ form.new_password2 }}
                                    <div class="input-icon-wrapper password-toggle-wrapper">
                                        <button type="button" class="password-toggle-btn" id="togglePassword2">
                                            <i class="fas fa-eye input-icon" id="eyeIcon2"></i>
                                        </button>
                                    </div>
                                </div>
                                {# Indicador de match (opcional, JS abaixo) #}
                                <p id="passwordMatch" class="help-text password-match-status" style="display: none;"></p>
                                {% if form.new_password2.errors %}<div class="form-errors field-errors">{% for error in form.new_password2.errors %}<p>{{ error }}</p>{% endfor %}</div>{% endif %}
                            </div>

                            {# Botão Submit #}
                            <div class="form-submit-group">
                                <button type="submit" class="button button-primary auth-button">
                                    <i class="fas fa-save"></i> Redefinir Senha
                                </button>
                            </div>
                        </div>
                    </form>

                {% else %} {# Mensagem se o link for inválido ou expirado #}
                     <div class="auth-header" style="text-align: center;">
                         <div class="error-icon" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;">
                             <i class="fas fa-times-circle"></i>
                         </div>
                        <h1 class="auth-title">Link Inválido</h1>
                        <p class="auth-subtitle" style="line-height: 1.5;">
                            O link de redefinição de senha que você usou é inválido ou já expirou.
                            Isso pode acontecer se ele já foi usado ou se você copiou incorretamente a URL.
                        </p>
                         <p class="auth-subtitle" style="margin-top: 1rem;">
                            Por favor, <a href="{% url 'accounts:password_reset' %}">solicite um novo link</a>.
                        </p>
                    </div>
                {% endif %} {# Fim do if validlink #}

            </div> {# Fim .auth-card-content #}
        </div> {# Fim .auth-card #}
    </div> {# Fim .auth-container #}
</div> {# Fim .auth-page-wrapper #}
{% endblock %}

{% block extra_js %}
{# JS para toggle de senha e indicador de força/match #}
<script>
    function setupPasswordToggle(inputId, buttonId, iconId) {
        const passwordInput = document.getElementById(inputId);
        const toggleButton = document.getElementById(buttonId);
        const eyeIcon = document.getElementById(iconId);

        if (passwordInput && toggleButton && eyeIcon) {
            toggleButton.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                eyeIcon.classList.toggle('fa-eye');
                eyeIcon.classList.toggle('fa-eye-slash');
            });
        }
    }

     // Password match checker
    function checkPasswordMatch() {
        const newPasswordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
        const confirmPasswordInput = document.getElementById('{{ form.new_password2.id_for_label }}');
        const matchText = document.getElementById('passwordMatch');

        if (!newPasswordInput || !confirmPasswordInput || !matchText) return;

        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (confirmPassword.length === 0 && newPassword.length === 0) {
            matchText.style.display = 'none';
            return;
        }

        matchText.style.display = 'block'; // Show the message area
        if (newPassword === confirmPassword) {
            matchText.textContent = 'As senhas coincidem!';
            matchText.className = 'help-text password-match-status match'; // Add 'match' class
        } else {
            matchText.textContent = 'As senhas não coincidem!';
            matchText.className = 'help-text password-match-status mismatch'; // Add 'mismatch' class
        }
    }

     // Password strength indicator
     function updatePasswordStrength() {
        const passwordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
        const strengthBar = document.getElementById('passwordStrength');
        if (!passwordInput || !strengthBar) return;

        const password = passwordInput.value;
        let strength = 0;
        let barColor = '#333'; // Default bar color

        if (password.length >= 8) strength += 25; else strength = Math.max(0, strength - 25);
        if (password.length >= 12) strength += 15;
        if (/[a-z]/.test(password)) strength += 10;
        if (/[A-Z]/.test(password)) strength += 15;
        if (/\d/.test(password)) strength += 15;
        if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 20;

        strength = Math.min(100, Math.max(0, strength)); // Clamp between 0 and 100

        strengthBar.style.width = strength + '%';

        if (strength < 40) {
            barColor = '#ef4444'; // red
        } else if (strength < 75) {
            barColor = '#f59e0b'; // orange/yellow
        } else {
            barColor = '#00B982'; // green (accent)
        }
        strengthBar.style.backgroundColor = barColor;
    }


    document.addEventListener('DOMContentLoaded', function() {
        setupPasswordToggle('{{ form.new_password1.id_for_label }}', 'togglePassword1', 'eyeIcon1');
        setupPasswordToggle('{{ form.new_password2.id_for_label }}', 'togglePassword2', 'eyeIcon2');

        // Add listeners for strength and match check
        const newPassInput = document.getElementById('{{ form.new_password1.id_for_label }}');
        const confirmPassInput = document.getElementById('{{ form.new_password2.id_for_label }}');

        if(newPassInput) {
            newPassInput.addEventListener('input', updatePasswordStrength);
            newPassInput.addEventListener('input', checkPasswordMatch); // Check match when typing new pass
        }
        if(confirmPassInput) {
            confirmPassInput.addEventListener('input', checkPasswordMatch);
        }

        // Initial checks if fields have values (e.g., after form error)
        updatePasswordStrength();
        checkPasswordMatch();
    });
</script>
{% endblock %}