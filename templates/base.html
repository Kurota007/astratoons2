{% load static wagtailcore_tags wagtailimages_tags wagtailsettings_tags %}

<!DOCTYPE html>
<html lang="{{ request.LANGUAGE_CODE|default:"en-us" }}">
<head>	
        <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WHFF1ENZSD"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-WHFF1ENZSD');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% if page.seo_title %}{{ page.seo_title }}{% else %}{% if page %}{{ page.title }}{% else %}Astraverse{% endif %}{% endif %}{% endblock %}{% block title_suffix %}{% if request.site %} | {{ request.site.site_name|default:'Astraverse' }}{% endif %}{% endblock %}</title>
    
    <!-- Favicon -->
    {% if settings.core.GlobalSettings.favicon %}
        {% image settings.core.GlobalSettings.favicon original as favicon_img %}
        <link rel="shortcut icon" href="{{ favicon_img.url }}">
    {% endif %}

    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- BOOTSTRAP 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- Variáveis de Cor (CSS) -->
    <style>
        :root {
            --navbar-bg-color: {{ settings.core.GlobalSettings.color_navbar|default:'#171717' }};
            --body-bg-color: {{ settings.core.GlobalSettings.color_background|default:'#000000' }};
            --main-text-color: {{ settings.core.GlobalSettings.color_text|default:'#e0e0e0' }};
            --light-text-color: {{ settings.core.GlobalSettings.color_text_light|default:'#a0a0a0' }};
            --accent-color: {{ settings.core.GlobalSettings.color_accent|default:'#2803ca' }};
            --border-color: {{ settings.core.GlobalSettings.color_border|default:'#2f2f2f' }};
            --card-bg-color: {{ settings.core.GlobalSettings.color_card_background|default:'#1e1e1e' }};
            --input-bg-color: {{ settings.core.GlobalSettings.color_input_background|default:'#2a2a2a' }};
            --input-border-color: {{ settings.core.GlobalSettings.color_input_border|default:'#4a4a4a' }};
            --button-primary-bg: var(--accent-color);
            --button-primary-text: {{ settings.core.GlobalSettings.color_button_primary_text|default:'white' }};
            --button-secondary-bg: {{ settings.core.GlobalSettings.color_button_secondary_bg|default:'#333333' }};
            --button-secondary-text: {{ settings.core.GlobalSettings.color_button_secondary_text|default:'#dddddd' }};
            --button-secondary-border: {{ settings.core.GlobalSettings.color_button_secondary_border|default:'#555555' }};
            --section-bg-color: {{ settings.core.GlobalSettings.color_section_background|default:'#101013' }};
            --danger-color: {{ settings.core.GlobalSettings.color_danger|default:'#ef4444' }};
        }
        body {
            background-color: var(--body-bg-color);
            color: var(--main-text-color);
            font-family: 'Poppins', sans-serif;
        }
        a { color: var(--accent-color); text-decoration: none; }
    </style>

    <!-- Seu CSS customizado (carregado depois do Bootstrap) -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/comments.css' %}">

    {% block extra_css %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">

    {% block header %}
        {% include "base/navbar.html" %}
    {% endblock %}

    <main>
        {% block content %}{% endblock %}
    </main>

    {% block footer %}
        {% include "base/footer.html" %}
    {% endblock %}
    
    <!-- SCRIPTS DE PUBLICIDADE (colocados aqui para não bloquear o carregamento da página) -->
    {% if request.resolver_match.view_name != 'manga:chapter_reader' and "/accounts/login/" not in request.path and "/accounts/signup/" not in request.path and "/subscriptions/plans/" not in request.path %}
        {% if not user.is_authenticated or not user.assinatura_vip.esta_ativa %}
            {{ settings.core.GlobalSettings.ad_script_monetag|safe }}
            {{ settings.core.GlobalSettings.ad_script_pertawee|safe }}
            {{ settings.core.GlobalSettings.ad_script_push_antiblock|safe }}
            {{ settings.core.GlobalSettings.ad_script_al5sm|safe }}
            {{ settings.core.GlobalSettings.ad_script_loajawun|safe }}
            {{ settings.core.GlobalSettings.ad_script_groleegni|safe }}
            {{ settings.core.GlobalSettings.ad_script_stoampaliy|safe }}
            {{ settings.core.GlobalSettings.ad_script_multizone|safe }}
        {% endif %}
    {% endif %}

    <!-- BOOTSTRAP 5 JS BUNDLE (necessário para dropdowns, modais, etc) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    {% block extra_js %}
    <script>
    // Seu JavaScript customizado para menus e live search (mantido)
    document.addEventListener('DOMContentLoaded', function() {
        const profileTrigger = document.getElementById('profileDropdownTrigger');
        const profileMenu = document.getElementById('profileDropdownMenu');
        if (profileTrigger && profileMenu) {
            profileMenu.classList.remove('active');
            profileTrigger.setAttribute('aria-expanded', 'false');
            const closeProfileDropdownOnClickOutside = (event) => {
                if (profileMenu.classList.contains('active') && !profileTrigger.contains(event.target) && !profileMenu.contains(event.target)) {
                    profileMenu.classList.remove('active');
                    profileTrigger.setAttribute('aria-expanded', 'false');
                }
            };
            profileTrigger.addEventListener('click', (event) => {
                event.stopPropagation();
                const isActive = profileMenu.classList.toggle('active');
                profileTrigger.setAttribute('aria-expanded', isActive.toString());
                if (isActive) { document.addEventListener('click', closeProfileDropdownOnClickOutside, { capture: true, once: true }); }
            });
            profileMenu.addEventListener('click', (event) => event.stopPropagation());
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && profileMenu.classList.contains('active')) {
                    profileMenu.classList.remove('active');
                    profileTrigger.setAttribute('aria-expanded', 'false');
                }
            });
        }

        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const mobileMenuPanel = document.getElementById('mobile-menu-nav');
        if (mobileMenuToggle && mobileMenuPanel) {
            const iconOpen = mobileMenuToggle.querySelector('.icon-open');
            const iconClose = mobileMenuToggle.querySelector('.icon-close');
            mobileMenuPanel.classList.remove('is-open');
            mobileMenuToggle.setAttribute('aria-expanded', 'false');
            if(iconOpen) iconOpen.style.display = 'inline';
            if(iconClose) iconClose.style.display = 'none';

            mobileMenuToggle.addEventListener('click', () => {
                const isOpen = mobileMenuPanel.classList.toggle('is-open');
                mobileMenuToggle.setAttribute('aria-expanded', isOpen.toString());
                if(iconOpen) iconOpen.style.display = isOpen ? 'none' : 'inline';
                if(iconClose) iconClose.style.display = isOpen ? 'inline' : 'none';
            });
        }
        
        function initializeLiveSearch(inputId, resultsId) {
            const searchInput = document.getElementById(inputId);
            const resultsContainer = document.getElementById(resultsId);
            if (!searchInput || !resultsContainer) return;
            const searchContainer = searchInput.closest('.search-container');

            let debounceTimer;
            const fetchAndShowResults = async () => {
                const query = searchInput.value.trim();
                if (query.length < 2) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.style.display = 'none';
                    return;
                }
                try {
                    const response = await fetch(`{% url 'search:live_search' %}?q=${encodeURIComponent(query)}`);
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    const data = await response.json();
                    
                    resultsContainer.innerHTML = '';
                    if (data.results && data.results.length > 0) {
                        data.results.forEach(result => {
                            const coverHtml = result.cover_url ? `<img src="${result.cover_url}" alt="" class="live-search-item-cover">` : '<div class="live-search-item-cover"></div>';
                            const itemHtml = `
                                <a href="${result.url}" class="live-search-item">
                                    ${coverHtml}
                                    <div class="live-search-item-info">
                                        <span class="live-search-item-title">${result.title}</span>
                                        <span class="live-search-item-meta">${result.chapters_text}</span>
                                    </div>
                                </a>`;
                            resultsContainer.insertAdjacentHTML('beforeend', itemHtml);
                        });
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsContainer.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Erro ao buscar resultados:', error);
                    resultsContainer.style.display = 'none';
                }
            };

            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(fetchAndShowResults, 300);
            });
            
            document.addEventListener('click', (event) => {
                if (searchContainer && !searchContainer.contains(event.target)) {
                    resultsContainer.style.display = 'none';
                }
            });

            searchInput.addEventListener('focus', () => {
                if (resultsContainer.innerHTML.trim() !== '') {
                    resultsContainer.style.display = 'block';
                }
            });
        }

        initializeLiveSearch('live-search-input-desktop', 'live-search-results-desktop');
        initializeLiveSearch('live-search-input-mobile', 'live-search-results-mobile');
    });
    </script>
    {% endblock %}
</body>
</html>