{% extends "base.html" %}
{% load comment_tags reaction_tags %}
{% load static wagtailcore_tags wagtailimages_tags wagtailsettings_tags humanize %}
{% get_settings %}

{% block title %}{{ page.title }}{% endblock %}
{% block body_class %}template-mangapage theme-dark{% endblock %}

{% block extra_css %}
    <style>
        .sidebar-actions { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
        .sidebar-sticky-content > * + * { margin-top: 1.5rem; }
        .pagination li { list-style: none; list-style-type: none; }
        .pagination ul { padding-left: 0; margin: 0; }
        .chapter-item { display: flex; align-items: center; gap: 0.5rem; }
        
        .chapter-link { 
            flex-grow: 1; 
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .bgm-icon {
            color: #a78bfa;
            margin-left: 8px;
            font-size: 0.8em;
            vertical-align: middle;
        }

        .chapter-item.read .chapter-link {
            opacity: 0.65;
        }
        .chapter-item.read:hover .chapter-link {
            opacity: 1;
        }

        .read-icon {
            display: none; /* Oculto por padrão */
            color: var(--color-accent, #00B982);
            margin-left: 8px;
            font-size: 0.8em;
            vertical-align: middle;
        }

        .chapter-item.read .read-icon {
            display: inline-block; /* Visível apenas em itens com a classe .read */
        }

        .chapter-number .vip-icon { color: #ffd700; margin-right: 8px; font-size: 0.9em; vertical-align: middle; }
        .sidebar-cover-image { position: relative; }
        .sidebar-cover-image .vip-badge {
            position: absolute; top: 12px; left: 12px; background-color: #ffd700; color: #1a1a1a;
            padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; z-index: 10;
            display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .sidebar-cover-image .status-badge {
            position: absolute; top: 12px; right: 12px; color: #ffffff;
            padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .reactions-container { border-bottom: 1px solid var(--color-border, #27272a); padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
        .reactions-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; text-align: center; color: var(--color-text, #e0e0e0); }
        .reactions-buttons-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; }
        .reaction-button { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; background-color: transparent; border: 2px solid var(--color-card-background, #18181b); padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; min-width: 90px; color: inherit; }
        .reaction-button:hover, .reaction-button.active { border-color: var(--color-accent, #00B982); background-color: rgba(0, 185, 130, 0.1); }
        .reaction-button.disabled { cursor: not-allowed; opacity: 0.5; }
        .reaction-icon-img { width: 32px; height: 32px; object-fit: contain; }
        .reaction-name { font-size: 0.9rem; font-weight: 500; color: var(--color-text-light, #a0a0a0); }
        .reaction-count { font-size: 0.8rem; font-weight: bold; color: var(--color-text, #e0e0e0); }
        .sidebar-relations-box, .sidebar-official-links {
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 1rem;
        }
        .relations-list, .official-links-list { list-style: none; padding: 0; margin: 0; }
        .relation-item, .official-links-list li { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color-light); }
        .relation-item:last-child, .official-links-list li:last-child { border-bottom: none; }
        .relation-type { color: var(--light-text-color); margin-right: 1rem; }
        .relation-work-link, .official-links-list a { font-weight: 600; text-decoration: none; color: var(--accent-color); }
        .relation-work-link:hover, .official-links-list a:hover { text-decoration: underline; }

        .sidebar-donation-box { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; }
        .donation-progress-bar-container { background-color: #373737; border-radius: 8px; overflow: hidden; margin-bottom: 0.5rem; height: 12px; }
        .donation-progress-bar { background-color: #4F46E5; height: 100%; transition: width 0.5s ease-in-out; border-radius: 8px; }
        .donation-status { text-align: center; font-size: 0.9rem; margin-bottom: 1rem; color: var(--light-text-color); }
        .donation-form { display: flex; gap: 0.75rem; align-items: center; }
        .donation-form .donation-amount-input { flex-grow: 1; text-align: center; background-color: #2b2d31; border: 1px solid var(--border-color); color: #fff; border-radius: 5px; padding: 0.6rem; width: 80px; }
        .donation-form .button { flex-grow: 2; }
        .user-balance-info { display: block; text-align: right; margin-top: 0.5rem; font-size: 0.8rem; color: #888; }
        .donation-message { margin-top: 1rem; text-align: center; font-weight: 600; min-height: 1.2em; font-size: 0.9rem; }
        .donation-message.success { color: #22c55e; }
        .donation-message.error { color: #ef4444; }

    </style>
{% endblock %}

{% block content %}
<div class="manga-detail-page">
    <section class="manga-detail-header">
        {% if page.cover %}{% image page.cover fill-1920x400 as header_bg %}<div class="header-background-image" style="background-image: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0.8) 20%, rgba(0,0,0,0.2) 60%, transparent 100%), url('{{ header_bg.url }}');"></div>{% endif %}
    </section>

    <section class="manga-detail-main-section">
        <div class="container">
            {% csrf_token %}
            <div class="manga-detail-grid">
                <div class="manga-detail-content">
                    <div class="manga-info-block">
                        <div class="manga-title-area">
                            <h1 class="manga-title">{{ page.title }}</h1>
                            {% if page.rating %}<div class="manga-rating"><i class="fas fa-star"></i> {{ page.rating|floatformat:1 }} / 10</div>{% endif %}
                        </div>
                        {% if page.alternative_titles %}<p class="manga-alternative-titles">({{ page.alternative_titles }})</p>{% endif %}
                        <div class="manga-tags">
                            {% if page.status %}<span class="tag status-tag status-{{ page.get_status_display|slugify }}">{{ page.get_status_display }}</span>{% endif %}
                            {% if page.manga_type %}<span class="tag type-tag type-{{ page.get_manga_type_display|slugify }}">{{ page.get_manga_type_display }}</span>{% endif %}
                            {% for genre_item in page.genre_items.all %}<a href="#" class="tag genre-tag genre-{{ genre_item.tag.slug }}">{{ genre_item.tag.name }}</a>{% endfor %}
                        </div>
                        {% if page.description %}<div class="manga-description">{{ page.description|richtext }}</div>{% endif %}
                    </div>
                    <hr class="separator">

                    <div class="tabs-container">
                        <div class="tab-list" role="tablist">
                            <button class="tab-trigger active" role="tab" aria-selected="true" aria-controls="tab-content-chapters">Lista de Capítulos</button>
                            {% if page.news_updates %}<button class="tab-trigger" role="tab" aria-selected="false" aria-controls="tab-content-notices">Avisos</button>{% endif %}
                        </div>

                        <div class="tab-content active" id="tab-content-chapters" role="tabpanel">
                            <div class="chapter-list-controls">
                                <form method="GET" action="." id="chapter-filter-form" class="chapter-filter-form">
                                    {% if current_sort and current_sort != 'desc' %}<input type="hidden" name="sort" value="{{ current_sort }}">{% endif %}
                                    <input type="search" name="q_chapter" class="chapter-filter-input" placeholder="Filtar capítulos..." value="{{ search_query|default:'' }}">
                                    <button type="submit" class="button button-small" title="Filtrar"><i class="fas fa-search"></i></button>
                                </form>
                                <div class="chapter-sort-buttons">
                                    <a href="{{ sort_url_desc|default:'?sort=desc' }}" title="Ordenar Decrescente" class="sort-button {% if current_sort == 'desc' or not current_sort %}active{% endif %}"><i class="fas fa-arrow-down-short-wide"></i></a>
                                    <a href="{{ sort_url_asc|default:'?sort=asc' }}" title="Ordenar Crescente" class="sort-button {% if current_sort == 'asc' %}active{% endif %}"><i class="fas fa-arrow-up-wide-short"></i></a>
                                </div>
                            </div>

                            <div class="chapter-group">
                                {% if chapters %}
                                    <ul class="chapter-item-list">
                                        {% for chapter in chapters %}
                                            <li class="chapter-item {% if chapter.id in read_chapter_ids %}read{% endif %}">
                                                <a href="{{ chapter.get_url }}" class="chapter-link">
                                                    <div class="chapter-thumbnail-wrapper">
                                                        {% with final_thumb=chapter.get_thumbnail %}
                                                            {% if final_thumb %}
                                                                {% if chapter.is_wagtail_thumbnail %}
                                                                    {% image final_thumb fill-140x80 as thumb_rendition %}
                                                                    <img src="{{ thumb_rendition.url }}" alt="Thumbnail para Cap. {{ chapter.chapter_number }}" class="chapter-thumbnail-img" loading="lazy">
                                                                {% elif chapter.is_standard_thumbnail %}
                                                                    <img src="{{ final_thumb.url }}" alt="Thumbnail para Cap. {{ chapter.chapter_number }}" class="chapter-thumbnail-img" loading="lazy" style="width: 140px; height: 80px; object-fit: cover;">
                                                                {% endif %}
                                                            {% else %}
                                                                <div class="chapter-thumbnail-placeholder"><i class="fas fa-image"></i></div>
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                    <div class="chapter-info">
                                                        <span class="chapter-number">
                                                            {% if chapter.is_effectively_vip %}<i class="fas fa-crown vip-icon" title="Capítulo VIP"></i>{% endif %}
                                                            Capítulo {{ chapter.chapter_number }}
                                                            {% if chapter.background_music %}<i class="fas fa-music bgm-icon" title="Contém música"></i>{% endif %}
                                                            <i class="fas fa-eye read-icon" title="Capítulo lido"></i>
                                                        </span>
                                                        {% if chapter.chapter_title %}<span class="chapter-title-separator">-</span><span class="chapter-title">{{ chapter.chapter_title }}</span>{% endif %}
                                                    </div>
                                                    <div class="chapter-meta">
                                                        <span class="chapter-views"><i class="fas fa-eye"></i> {{ chapter.views }}</span>
                                                        <span class="chapter-date"><i class="far fa-clock"></i> {{ chapter.release_date_or_published|date:"d/m/Y" }}</span>
                                                    </div>
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                    {% if chapters.paginator.num_pages > 1 %}{% include "includes/_pagination.html" with page_obj=chapters request=request search_query=search_query current_sort=current_sort sort_url_desc=sort_url_desc sort_url_asc=sort_url_asc %}{% endif %}
                                {% else %}
                                    <p class="empty-list-message">
                                        {% if search_query %}Nenhum capítulo encontrado para "{{ search_query }}".
                                        {% else %}Nenhum capítulo encontrado para esta obra ainda.{% endif %}
                                    </p>
                                {% endif %}
                            </div>
                        </div>

                        {% if page.news_updates %}
                        <div class="tab-content" id="tab-content-notices" role="tabpanel" style="display: none;">
                            <div class="manga-notices">{{ page.news_updates|richtext }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <aside class="manga-detail-sidebar">
                    <div class="sidebar-sticky-content">
                        <div class="sidebar-cover-image">
                            {% if page.chapters_are_vip or page.has_vip_chapters %}<span class="vip-badge"><i class="fas fa-crown"></i> OBRA VIP</span>{% endif %}
                            {% with status_badge=page.display_status %}{% if status_badge %}<span class="status-badge" style="background-color: {{ status_badge.color }};">{{ status_badge.text }}</span>{% endif %}{% endwith %}
                            {% if page.cover %}{% image page.cover fill-300x450 as cover_img %}<img src="{{ cover_img.url }}" alt="{{ page.title }} Capa" loading="lazy">{% else %}<div class="cover-placeholder">Sem Capa</div>{% endif %}
                        </div>
                        <div class="sidebar-actions">
                            <button type="button" class="button button-secondary button-rate" disabled title="Funcionalidade em breve"><i class="far fa-star"></i> Avaliar Obra (em breve)</button>
                            {% if user.is_authenticated %}<button type="button" class="button button-bookmark {% if is_following %}button-secondary bookmarked{% else %}button-primary{% endif %}" id="follow-manga-btn" data-manga-id="{{ page.pk }}" data-api-url="{% url 'manga:api_toggle_favorite' %}" aria-label="{% if is_following %}Remover dos Favoritos{% else %}Adicionar aos Favoritos{% endif %}"><i class="{% if is_following %}fas fa-bookmark{% else %}far fa-bookmark{% endif %}"></i> <span class="follow-text">{% if is_following %}Favoritado{% else %}Favoritar{% endif %}</span></button>{% else %}<a href="{% url 'account_login' %}?next={{ request.build_absolute_uri }}" class="button button-primary" title="Faça login para favoritar"><i class="far fa-bookmark"></i> Favoritar</a>{% endif %}
                        </div>
                        
                        {% if page.release_day %}<div class="sidebar-release-schedule"><h4 class="details-title">Lançamentos:</h4><div class="schedule-days"><span class="day {% if page.release_day == 'MON' %}active{% endif %}">SEG</span><span class="day {% if page.release_day == 'TUE' %}active{% endif %}">TER</span><span class="day {% if page.release_day == 'WED' %}active{% endif %}">QUA</span><span class="day {% if page.release_day == 'THU' %}active{% endif %}">QUI</span><span class="day {% if page.release_day == 'FRI' %}active{% endif %}">SEX</span><span class="day {% if page.release_day == 'SAT' %}active{% endif %}">SÁB</span><span class="day {% if page.release_day == 'SUN' %}active{% endif %}">DOM</span></div></div>{% endif %}
                        
                        {% if user.is_authenticated and page.donation_box_visible %}<div id="donation-widget" class="sidebar-donation-box"><h4 class="details-title">Apoie o Próximo Capítulo!</h4><div class="donation-progress-bar-container">{% with percentage=page.get_donation_percentage|default:0 %}<div id="donation-progress-bar" class="donation-progress-bar" style="width: {{ percentage }}%;"></div>{% endwith %}</div><p id="donation-status" class="donation-status"><span id="current-donations">{{ page.current_donations }}</span> / <span id="donation-goal">{{ page.donation_goal }}</span> Moedas</p><div class="donation-form"><input type="number" id="donation-amount-input" class="donation-amount-input" placeholder="Qtd." min="1"><button id="donate-button" class="button button-primary">Doar Moedas</button></div><small id="user-balance-info" class="user-balance-info">Seu saldo: {{ user.profile.moedas }} moedas</small><div id="donation-message" class="donation-message"></div></div>{% endif %}

                        {% if page.source_relations.all %}<div class="sidebar-relations-box"><h4 class="details-title">Relações</h4><ul class="relations-list">{% for relation in page.source_relations.all %}{% pageurl relation.target_work as related_url %}<li class="relation-item"><span class="relation-type">{{ relation.get_relation_type_display }}:</span><a href="{{ related_url }}" class="relation-work-link">{{ relation.target_work.title }}</a></li>{% endfor %}</ul></div>{% endif %}
                        
                        {% if page.original_link_kr or page.original_link_jp or page.original_link_cn or page.original_link_en %}
                        <div class="sidebar-official-links">
                            <h4 class="details-title">Links Oficiais</h4>
                            <ul class="official-links-list">
                                {% if page.original_link_kr %}<li><a href="{{ page.original_link_kr }}" target="_blank" rel="noopener noreferrer">Original (KR)</a></li>{% endif %}
                                {% if page.original_link_jp %}<li><a href="{{ page.original_link_jp }}" target="_blank" rel="noopener noreferrer">Original (JP)</a></li>{% endif %}
                                {% if page.original_link_cn %}<li><a href="{{ page.original_link_cn }}" target="_blank" rel="noopener noreferrer">Original (CN)</a></li>{% endif %}
                                {% if page.original_link_en %}<li><a href="{{ page.original_link_en }}" target="_blank" rel="noopener noreferrer">Oficial (EN)</a></li>{% endif %}
                            </ul>
                        </div>
                        {% endif %}

                        <div class="sidebar-details-box"><h4 class="details-title">Detalhes</h4><dl class="details-list">{% if page.release_year %}<dt>Ano:</dt><dd>{{ page.release_year }}</dd>{% endif %}{% if page.author %}<dt>Autor:</dt><dd>{{ page.author }}</dd>{% endif %}{% if page.artist %}<dt>Artista:</dt><dd>{{ page.artist }}</dd>{% endif %}{% if page.publisher %}<dt>Editora:</dt><dd>{{ page.publisher }}</dd>{% endif %}{% if chapter_count is not None %}<dt>Capítulos:</dt><dd>{{ chapter_count }}</dd>{% endif %}{% if page.views_count is not None %}<dt>Visualizações:</dt><dd>{{ page.views_count|intcomma }}</dd>{% endif %}{% if followers_count is not None %}<dt class="followers-label">Favoritos:</dt><dd class="followers-value" id="followers-count-display">{{ followers_count }}</dd>{% endif %}</dl></div>
                    </div>
                </aside>
            </div>

            {% if settings.core.GlobalSettings.comment_provider == 'custom' %}<section class="manga-interactions-section my-5">{% reaction_section page=page %}<hr class="my-5" style="border-color: var(--color-border, #27272a);">{% comment_section page %}</section>{% endif %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}{{ block.super }}<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabContainer = document.querySelector('.tabs-container');
    if (tabContainer) {
        const tabTriggers = tabContainer.querySelectorAll('.tab-trigger');
        const tabContents = tabContainer.querySelectorAll('.tab-content');
        tabTriggers.forEach(trigger => {
            trigger.addEventListener('click', function() {
                const targetId = this.getAttribute('aria-controls');
                tabTriggers.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
                tabContents.forEach(c => { c.classList.remove('active'); c.style.display = 'none'; });
                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
                const targetContent = tabContainer.querySelector('#' + targetId);
                if (targetContent) {
                    targetContent.classList.add('active');
                    targetContent.style.display = 'block';
                }
            });
        });
        const activeTrigger = tabContainer.querySelector('.tab-trigger.active');
        const activeContentId = activeTrigger ? activeTrigger.getAttribute('aria-controls') : null;
        tabContents.forEach(c => {
            c.style.display = (c.id === activeContentId) ? 'block' : 'none';
        });
    }

    const bookmarkButton = document.getElementById('follow-manga-btn');
    if (bookmarkButton) {
        bookmarkButton.addEventListener('click', function() {
            const csrfTokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            const followersCountElement = document.getElementById('followers-count-display');
            if (!csrfTokenInput || !followersCountElement) return;
            const csrfToken = csrfTokenInput.value;
            const mangaId = this.dataset.mangaId;
            const apiUrl = this.dataset.apiUrl;
            const followTextElement = this.querySelector('.follow-text');
            const iconElement = this.querySelector('i');
            this.disabled = true;
            const originalText = followTextElement.textContent;
            followTextElement.textContent = '...';
            fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ 'manga_id': mangaId })
                })
                .then(response => {
                    if (!response.ok) { return response.json().then(err => { throw new Error(err.message || 'Erro no servidor'); }); }
                    return response.json();
                })
                .then(data => {
                    let currentCount = parseInt(followersCountElement.textContent.replace(/,/g, '')) || 0;
                    if (data.action === 'added') {
                        followTextElement.textContent = 'Favoritado';
                        iconElement.className = 'fas fa-bookmark';
                        this.classList.remove('button-primary');
                        this.classList.add('button-secondary', 'bookmarked');
                        followersCountElement.textContent = (currentCount + 1).toLocaleString();
                    } else {
                        followTextElement.textContent = 'Favoritar';
                        iconElement.className = 'far fa-bookmark';
                        this.classList.remove('button-secondary', 'bookmarked');
                        this.classList.add('button-primary');
                        followersCountElement.textContent = (currentCount > 0 ? currentCount - 1 : 0).toLocaleString();
                    }
                })
                .catch(error => {
                    console.error('Erro ao favoritar:', error);
                    followTextElement.textContent = originalText;
                })
                .finally(() => { this.disabled = false; });
        });
    }

    const commentSection = document.querySelector('.manga-interactions-section');
    if (commentSection) {
        const mainForm = commentSection.querySelector('.comment-form > form');
        if (mainForm) {
            const mainTextarea = mainForm.querySelector('textarea');
            const mainFormActions = mainForm.querySelectorAll('.submit-row, .formatting-toolbar');
            
            if (mainTextarea) {
                mainTextarea.addEventListener('focus', () => {
                    mainFormActions.forEach(el => { el.style.display = 'block'; });
                }, { once: true });
            }
        }
        
        commentSection.addEventListener('click', function(event) {
            const replyButton = event.target.closest('a.comment-reply-link');
            if (!replyButton) return;
            
            event.preventDefault();
            const targetId = replyButton.getAttribute('href');
            if (!targetId || !targetId.startsWith('#')) return;
            const targetForm = document.querySelector(targetId);
            if (!targetForm) return;
            const isVisible = targetForm.style.display === 'block';
            commentSection.querySelectorAll('.comment-reply-form').forEach(form => { form.style.display = 'none'; });
            if (!isVisible) {
                targetForm.style.display = 'block';
                const textarea = targetForm.querySelector('textarea');
                if (textarea) { textarea.focus(); }
            }
        });
    }

    const donationWidget = document.getElementById('donation-widget');
    if (donationWidget) {
        const donateButton = document.getElementById('donate-button');
        const amountInput = document.getElementById('donation-amount-input');
        const messageDiv = document.getElementById('donation-message');
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        donateButton.addEventListener('click', function() {
            const amount = parseInt(amountInput.value);
            if (isNaN(amount) || amount <= 0) {
                messageDiv.textContent = 'Por favor, insira um valor válido.';
                messageDiv.className = 'donation-message error';
                return;
            }
            this.disabled = true;
            this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Doando...';
            messageDiv.textContent = '';
            fetch("{% url 'manga:donate_to_manga' manga_slug=page.slug %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'amount': amount })
            })
            .then(response => { if (!response.ok) { return response.json().then(err => { throw err; }); } return response.json(); })
            .then(data => {
                messageDiv.textContent = data.message;
                if (data.status === 'success') {
                    messageDiv.className = 'donation-message success';
                    document.getElementById('user-balance-info').textContent = `Seu saldo: ${data.new_user_balance} moedas`;
                    document.getElementById('current-donations').textContent = data.new_manga_donations;
                    const donationGoal = parseFloat(document.getElementById('donation-goal').textContent) || 1;
                    const newPercentage = (data.new_manga_donations / donationGoal) * 100;
                    document.getElementById('donation-progress-bar').style.width = `${newPercentage}%`;
                    amountInput.value = '';
                    if (data.new_manga_donations >= donationGoal) { document.getElementById('donation-widget').style.display = 'none'; }
                } else { throw new Error(data.message || 'Ocorreu um erro desconhecido.'); }
            })
            .catch(error => {
                console.error('Erro na doação:', error);
                messageDiv.textContent = error.message || 'Ocorreu um erro de conexão.';
                messageDiv.className = 'donation-message error';
            })
            .finally(() => { this.disabled = false; this.innerHTML = 'Doar Moedas'; });
        });
    }

    document.body.addEventListener('click', function(event) {
        const button = event.target.closest('.reaction-button:not(.disabled)');
        if (!button) return;
        const csrfTokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (!csrfTokenElement) return;
        const pageId = button.dataset.pageId;
        const reactionTypeId = button.dataset.reactionType;
        const csrfToken = csrfTokenElement.value;
        document.querySelectorAll('.reaction-button').forEach(btn => { btn.disabled = true; });
        fetch("{% url 'core:api_toggle_reaction' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ page_id: pageId, reaction_type_id: reactionTypeId })
            })
            .then(response => {
                if (response.status === 401 || response.status === 403) { window.location.href = "{% url 'account_login' %}?next=" + window.location.pathname; throw new Error('Usuário não autenticado.'); }
                if (!response.ok) throw new Error('Falha na resposta da rede.');
                return response.json();
            })
            .then(data => {
                if (data && data.status === 'ok') {
                    data.counts.forEach(item => {
                        const countElement = document.getElementById(`reaction-count-${pageId}-${item.type_id}`);
                        if (countElement) countElement.textContent = item.count;
                    });
                    document.querySelectorAll('.reaction-button').forEach(btn => {
                        btn.classList.remove('active');
                        if (data.user_reacted_with && btn.dataset.reactionType === data.user_reacted_with) { btn.classList.add('active'); }
                    });
                } else { throw new Error(data.message || 'Erro desconhecido da API.'); }
            })
            .catch(error => { console.error('Erro no fetch da reação:', error); })
            .finally(() => { document.querySelectorAll('.reaction-button').forEach(btn => { btn.disabled = false; }); });
    });
});
</script>
{% endblock %}